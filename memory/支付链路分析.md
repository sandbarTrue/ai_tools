# æ”¯ä»˜é“¾è·¯åˆ†æ â€” junaitools.com

> æ›´æ–°æ—¶é—´: 2025-02-15

## 1. æ”¯ä»˜ç³»ç»Ÿï¼šCreem

ä½¿ç”¨ [Creem](https://creem.io) ä½œä¸ºæ”¯ä»˜ç½‘å…³ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢å‘ç‹¬ç«‹å¼€å‘è€…/SaaSçš„æ”¯ä»˜å¹³å°ã€‚

### å½“å‰é…ç½®çŠ¶æ€

| é…ç½®é¡¹ | æµ‹è¯•ç¯å¢ƒå€¼ | ç”Ÿäº§ç¯å¢ƒå€¼ |
|--------|-----------|-----------|
| API Base URL | `https://test-api.creem.io` | `https://api.creem.io` |
| API Key | `creem_test_4Fie5qeiWHO9bL99G5Yw6b` (ç¡¬ç¼–ç ) | `your_production_api_key_here` âŒæœªè®¾ç½® |
| Product ID | `prod_1hcYYAaYx0bWMGwtuGTPft` (ç¡¬ç¼–ç ) | `your_production_product_id_here` âŒæœªè®¾ç½® |
| Webhook Secret | `your_webhook_secret_here` âŒæœªè®¾ç½® | åŒå·¦ |
| ç¯å¢ƒåˆ‡æ¢ | é€šè¿‡ `NODE_ENV` ç¯å¢ƒå˜é‡ | åŒå·¦ |

**ç»“è®ºï¼šå½“å‰å¤„äºæµ‹è¯•æ¨¡å¼ï¼Œç”Ÿäº§ç¯å¢ƒ API Key å’Œ Product ID å‡æœªé…ç½®ã€‚**

### ç¯å¢ƒåˆ‡æ¢é€»è¾‘ï¼ˆsrc/config.jsï¼‰

```
NODE_ENV=production â†’ api.creem.io + ç”Ÿäº§API Key
NODE_ENV=developmentï¼ˆé»˜è®¤ï¼‰â†’ test-api.creem.io + æµ‹è¯•API Key
```

ä¼˜å…ˆçº§ï¼š`process.env` > `.env` æ–‡ä»¶ > `ENVIRONMENT` ç¯å¢ƒå˜é‡ > é»˜è®¤ development

---

## 2. å·²æœ‰çš„æ”¯ä»˜æµç¨‹

### å®Œæ•´é“¾è·¯å›¾

```
ç”¨æˆ·ç‚¹å‡» "Pay $4.49"
      â”‚
      â–¼
å‰ç«¯ POST /api/create-checkout
      â”‚ (éœ€è¦ç™»å½• requireAuth)
      â–¼
åç«¯ â†’ Creem API: POST /v1/checkouts
      â”‚ (æºå¸¦ product_id, success_url, cancel_url, metadata)
      â–¼
è¿”å› checkout_url â†’ è·³è½¬åˆ° Creem æ”¯ä»˜é¡µé¢
      â”‚
      â”œâ”€â”€ æ”¯ä»˜æˆåŠŸ â†’ é‡å®šå‘åˆ° /payment/success
      â”‚     â”‚ (å¸¦ checkout_id, order_id, customer_id, signature ç­‰å‚æ•°)
      â”‚     â–¼
      â”‚   éªŒè¯ redirect ç­¾åï¼ˆSHA256ï¼‰
      â”‚     â”‚
      â”‚     â–¼
      â”‚   æŸ¥è¯¢ Creem API: GET /v1/checkouts/{checkout_id}
      â”‚     â”‚
      â”‚     â–¼
      â”‚   æ˜¾ç¤ºæ”¯ä»˜ç»“æœé¡µé¢ï¼ˆæˆåŠŸ/å¤±è´¥/å¤„ç†ä¸­ï¼‰
      â”‚
      â”œâ”€â”€ ç”¨æˆ·å–æ¶ˆ â†’ é‡å®šå‘åˆ° /payment/cancel
      â”‚     â–¼
      â”‚   æ˜¾ç¤ºå–æ¶ˆé¡µé¢
      â”‚
      â””â”€â”€ Creem Webhook â†’ POST /creem/webhook
            â”‚ (å¼‚æ­¥é€šçŸ¥ï¼Œä½œä¸ºå¤‡ä»½ç¡®è®¤)
            â–¼
          éªŒè¯ creem-signatureï¼ˆHMAC-SHA256ï¼‰
            â”‚
            â–¼
          æ ¹æ®äº‹ä»¶ç±»å‹è®°å½•æ—¥å¿—ï¼ˆåªè®°æ—¥å¿—ï¼Œä¸åšä¸šåŠ¡é€»è¾‘ï¼‰
```

### æ”¯æŒçš„ Webhook äº‹ä»¶

- `checkout.completed` â€” æ”¯ä»˜å®Œæˆï¼ˆå¤‡ä»½ç¡®è®¤ï¼Œä¸»å¤„ç†åœ¨ redirect URLï¼‰
- `subscription.paid` â€” è®¢é˜…ä»˜è´¹
- `subscription.canceled` â€” è®¢é˜…å–æ¶ˆ
- `refund.created` â€” é€€æ¬¾
- `dispute.created` â€” äº‰è®®

### æ”¯ä»˜äº§å“

- **Citation Generator Pro** â€” $4.49 ä¸€æ¬¡æ€§ä»˜æ¬¾
- åŠŸèƒ½ï¼šMLA, APA, Chicago, Harvard, IEEE å…¨æ ¼å¼ + æ— é™ç”Ÿæˆ + å¯¼å‡º + ä¼˜å…ˆæ”¯æŒ

### æ•°æ®åº“è¡¨

`payment_records` è¡¨å·²è®¾è®¡ï¼ˆschema.sqlï¼‰ï¼Œå­—æ®µåŒ…æ‹¬ï¼š
- user_id, checkout_id, order_id, amount, currency, status, payment_method
- status: pending/completed/failed/cancelled

### é¡µé¢è·¯ç”±

| è·¯ç”± | è¯´æ˜ | è®¤è¯ |
|------|------|------|
| `/testPay` | æ”¯ä»˜å…¥å£é¡µ | éœ€ç™»å½• |
| `/payment-test` | æ”¯ä»˜æµ‹è¯•é¡µï¼ˆé™æ€HTMLï¼‰ | éœ€ç™»å½• |
| `/api/create-checkout` | åˆ›å»ºæ”¯ä»˜ä¼šè¯ API | éœ€ç™»å½• |
| `/payment/success` | æ”¯ä»˜æˆåŠŸå›è°ƒé¡µ | éœ€ç™»å½• |
| `/payment/cancel` | æ”¯ä»˜å–æ¶ˆé¡µ | éœ€ç™»å½• |
| `/payment/failed` | æ”¯ä»˜å¤±è´¥é¡µ | éœ€ç™»å½• |
| `/payment/status/:checkoutId` | æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢ API | éœ€ç™»å½• |
| `/creem/webhook` | Creem Webhook æ¥æ”¶ | æ— éœ€ç™»å½• |

---

## 3. é—®é¢˜å’Œç¼ºå¤±é¡¹

### ğŸ”´ å…³é”®ç¼ºå¤±ï¼ˆæ­£å¼ä¸Šçº¿å¿…éœ€ï¼‰

1. **ç”Ÿäº§ç¯å¢ƒ API Key æœªè®¾ç½®** â€” `CREEM_API_KEY` ç”Ÿäº§å€¼ä¸ºå ä½ç¬¦
2. **ç”Ÿäº§ç¯å¢ƒ Product ID æœªè®¾ç½®** â€” `CREEM_PRODUCT_ID` ç”Ÿäº§å€¼ä¸ºå ä½ç¬¦
3. **Webhook Secret æœªè®¾ç½®** â€” `CREEM_WEBHOOK_SECRET` ä¸ºå ä½ç¬¦ï¼Œç­¾åéªŒè¯å®é™…è¢«è·³è¿‡
4. **Webhook ä¸åšä¸šåŠ¡é€»è¾‘** â€” å½“å‰åªè®°æ—¥å¿—ï¼Œæœªå®é™…å†™å…¥ `payment_records` è¡¨
5. **æ”¯ä»˜æˆåŠŸåæ— æƒé™è§£é”** â€” æ”¯ä»˜æˆåŠŸé¡µé¢æ˜¾ç¤º "Pro Features Unlocked" ä½†æ²¡æœ‰å®é™…çš„ç”¨æˆ·æƒé™å˜æ›´é€»è¾‘
6. **ç”¨æˆ·å‡çº§çŠ¶æ€æœªæŒä¹…åŒ–** â€” æ²¡æœ‰ `users.is_premium` æˆ– `subscriptions` è¡¨æ¥è·Ÿè¸ªä»˜è´¹çŠ¶æ€

### ğŸŸ¡ æ½œåœ¨é—®é¢˜

1. **ä»£ç é‡å¤** â€” `server.js` å’Œ `payment.js` ä¸­å­˜åœ¨é‡å¤çš„ webhook å¤„ç†å’Œæ”¯ä»˜é¡µé¢ä»£ç ï¼ˆå·²éƒ¨åˆ†è¿ç§»åˆ°è·¯ç”±æ¨¡å—ä½† server.js ä¸­ä»ä¿ç•™æ—§ä»£ç ï¼‰
2. **paymentPages.js ä¸­ `crypto` æœªå¯¼å…¥** â€” `verifyRedirectSignature` å‡½æ•°ä½¿ç”¨äº† `crypto` ä½†æ–‡ä»¶å¤´æœª `require('crypto')`
3. **æµ‹è¯• API Key ç¡¬ç¼–ç ** â€” è™½ç„¶æ˜¯æµ‹è¯•ç¯å¢ƒï¼Œä½†æ•æ„Ÿä¿¡æ¯åº”ä»ç¯å¢ƒå˜é‡è¯»å–
4. **æ”¯ä»˜æˆåŠŸé¡µé¢éœ€è¦ç™»å½•** â€” redirect å›è°ƒåŠ äº† `requireAuth`ï¼Œå¦‚æœç”¨æˆ· session è¿‡æœŸä¼šå¯¼è‡´æ”¯ä»˜æˆåŠŸä½†çœ‹ä¸åˆ°ç»“æœ

### ğŸŸ¢ å·²å®Œæˆ

- âœ… Creem API é›†æˆåŸºç¡€æ¡†æ¶
- âœ… Checkout åˆ›å»ºæµç¨‹
- âœ… é‡å®šå‘ç­¾åéªŒè¯é€»è¾‘
- âœ… Webhook ç­¾åéªŒè¯é€»è¾‘
- âœ… æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢ API
- âœ… æˆåŠŸ/å¤±è´¥/å–æ¶ˆé¡µé¢
- âœ… æ•°æ®åº“ schema åŒ…å« payment_records è¡¨
- âœ… æµ‹è¯•æ–‡æ¡£ï¼ˆWEBHOOK_TESTING.mdï¼‰
- âœ… ç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢ï¼ˆtest/productionï¼‰

---

## 4. æ­£å¼ä¸Šçº¿ TODO

### ç¬¬ä¸€æ­¥ï¼šCreem é…ç½®
- [ ] åœ¨ Creem ä»ªè¡¨æ¿åˆ›å»ºæ­£å¼äº§å“ï¼ˆè·å–ç”Ÿäº§ Product IDï¼‰
- [ ] è·å–ç”Ÿäº§ API Key
- [ ] è®¾ç½® Webhook Secret
- [ ] é…ç½® Webhook URL ä¸º `https://junaitools.com/creem/webhook`
- [ ] å°†ä»¥ä¸Šé…ç½®å†™å…¥ `.env.production` æ–‡ä»¶

### ç¬¬äºŒæ­¥ï¼šä¸šåŠ¡é€»è¾‘å®Œå–„
- [ ] åœ¨ users è¡¨å¢åŠ  `is_premium` å­—æ®µæˆ–åˆ›å»º subscriptions è¡¨
- [ ] Webhook `checkout.completed` äº‹ä»¶å¤„ç†ï¼šå†™å…¥ payment_records + æ›´æ–°ç”¨æˆ·ä»˜è´¹çŠ¶æ€
- [ ] æ”¯ä»˜æˆåŠŸ redirect é¡µé¢ï¼šå®é™…æ¿€æ´»ç”¨æˆ· Pro æƒé™
- [ ] æ‰€æœ‰éœ€è¦ä»˜è´¹çš„åŠŸèƒ½åŠ æƒé™æ£€æŸ¥ä¸­é—´ä»¶
- [ ] ä¿®å¤ paymentPages.js ä¸­ `crypto` æœªå¯¼å…¥çš„ bug

### ç¬¬ä¸‰æ­¥ï¼šå®‰å…¨åŠ å›º
- [ ] ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç çš„æµ‹è¯• API Keyï¼Œç»Ÿä¸€ç”¨ç¯å¢ƒå˜é‡
- [ ] ç¡®ä¿ Webhook Secret æ­£ç¡®é…ç½®åå†ä¸Šçº¿
- [ ] è€ƒè™‘æ”¯ä»˜æˆåŠŸå›è°ƒé¡µæ˜¯å¦çœŸçš„éœ€è¦ `requireAuth`ï¼ˆå¯èƒ½å¯¼è‡´ session è¿‡æœŸé—®é¢˜ï¼‰

### ç¬¬å››æ­¥ï¼šæ¸…ç†
- [ ] æ¸…ç† server.js ä¸­é‡å¤çš„æ”¯ä»˜ä»£ç ï¼ˆå·²è¿ç§»åˆ°è·¯ç”±æ¨¡å—çš„éƒ¨åˆ†ï¼‰
- [ ] ç»Ÿä¸€ä½¿ç”¨è·¯ç”±æ¨¡å—ç‰ˆæœ¬çš„ webhook å¤„ç†
